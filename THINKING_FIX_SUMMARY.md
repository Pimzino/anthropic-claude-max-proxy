# Extended Thinking Fix - Summary

## The Problem

When using `sonnet-4-5-reasoning-*` models through the OpenAI compatibility layer, thinking was being disabled after the first request, and then we got 400 errors from Anthropic.

## Root Cause

We had **two fundamental misunderstandings**:

### Misunderstanding #1: Thinking is Mandatory
❌ **Wrong**: "If thinking is enabled and tools are used, there MUST be thinking blocks"
✅ **Correct**: "Claude decides whether to use thinking based on task complexity"

From Anthropic docs:
> "Claude may not use the entire budget allocated, especially at ranges above 32k"
> "The thinking budget is a target rather than a strict limit—actual token usage may vary based on the task"

### Misunderstanding #2: We Can Create Thinking Blocks
❌ **Wrong**: "If there's no thinking block, we should create an empty one"
✅ **Correct**: "Thinking blocks MUST have signatures from Claude - we cannot create them"

The error we got:
```
"messages.1.content.0.thinking.signature: Field required"
```

This happened because we tried to send:
```python
{"type": "thinking", "thinking": ""}  # Missing required 'signature' field!
```

## What Anthropic Actually Requires

From the official documentation:

### 1. Thinking Budget = Permission, Not Command

```json
{
  "thinking": {
    "type": "enabled",
    "budget_tokens": 32000
  }
}
```

This means: "Claude, you're **allowed** to use up to 32k tokens for reasoning if you need it"

**NOT**: "Claude, you **must** use 32k tokens for reasoning"

### 2. Thinking Blocks Must Have Signatures

When sending thinking blocks TO the API:
```json
{
  "type": "thinking",
  "thinking": "Let me analyze...",
  "signature": "WaUjzkypQ2mUEVM36O2TxuC06KN8xyfbJwyem2dw..."  // REQUIRED!
}
```

The signature:
- Is generated by Claude
- Verifies the thinking block is authentic
- Cannot be created by us
- Must be preserved exactly as received

### 3. Thinking Blocks Are Optional

**Scenario A: Simple Task**
```
User: "List all Python files"
Claude: [No thinking needed] → Returns tool_use, NO thinking blocks
Result: ✅ This is normal and correct!
```

**Scenario B: Complex Task**
```
User: "Analyze this codebase architecture and suggest improvements"
Claude: [Needs deep reasoning] → Returns thinking blocks + tool_use
Result: ✅ Cache the thinking blocks for next turn
```

### 4. When to Preserve Thinking Blocks

From the docs:
> "During tool use, you must pass `thinking` blocks back to the API, and you must include the complete unmodified block back to the API."

**But this only applies when thinking blocks exist!**

- If Claude generated thinking blocks → Preserve them with signatures
- If Claude didn't generate thinking blocks → Nothing to preserve, continue normally

## The Fix

### The Real Anthropic Requirement

From the error message:
```
"When `thinking` is enabled, a final `assistant` message must start with a thinking block
(preceeding the lastmost set of `tool_use` and `tool_result` blocks)"
```

**This is a STRICT requirement** - if thinking is enabled and there's a last assistant message with tool_use, it MUST start with a thinking block.

### What We Changed

**Before (WRONG):**
```python
# Always enable thinking
anthropic_request["thinking"] = {
    "type": "enabled",
    "budget_tokens": thinking_budget
}
# This breaks when there's a last assistant message with tools but no thinking block!
```

**After (CORRECT):**
```python
# Check if we can safely enable thinking
last_assistant_has_tools = _last_assistant_has_tool_use(messages)
last_assistant_has_thinking = _last_assistant_starts_with_thinking(messages)

if last_assistant_has_tools and not last_assistant_has_thinking:
    # Can't enable thinking - would violate Anthropic's requirement
    can_enable_thinking = False
else:
    # Safe to enable thinking
    anthropic_request["thinking"] = {
        "type": "enabled",
        "budget_tokens": thinking_budget
    }
```

### Key Changes

1. **Conditionally enable thinking** - Only enable if we can satisfy Anthropic's requirement
2. **Check for last assistant message** - If it has tool_use, it must have thinking
3. **Try to reattach from cache** - Look up thinking blocks by tool_use ID
4. **Disable if necessary** - If we can't provide thinking block, disable thinking for this turn
5. **Re-enable next turn** - Thinking can be enabled again when there's no conflicting assistant message

### The Chicken-and-Egg Problem

Here's the issue we face:

**Turn 1 (First message):**
- ✅ No last assistant message
- ✅ Can enable thinking
- Claude: "Simple task, I don't need extended thinking"
- Response: text + tool_use, NO thinking blocks
- Cache: Empty (nothing to cache)

**Turn 2 (After tool results):**
- ❌ Last assistant message has tool_use but NO thinking
- ❌ Cache is empty (Claude didn't generate thinking)
- ❌ Cannot enable thinking (would violate Anthropic's requirement)
- Solution: Disable thinking for this turn

**Turn 3 (After more tool results):**
- ✅ Last assistant message from Turn 2 has no tool_use (only text response)
- ✅ Can enable thinking again
- Claude: May or may not use thinking depending on task

### Why This Happens

Thinking is **optional** - Claude only uses it for complex tasks. Simple tool calls like:
- "List files in directory" → No thinking needed
- "Read file contents" → No thinking needed
- "Search for pattern" → No thinking needed

But complex analysis like:
- "Analyze architecture and suggest improvements" → Thinking used
- "Find security vulnerabilities" → Thinking used
- "Refactor for performance" → Thinking used

## How It Works Now

### Flow for Simple Tasks (No Thinking Generated)

1. **Request 1**: Enable thinking → Claude gets simple task → No thinking blocks generated
2. **Cache**: Nothing to cache (this is fine!)
3. **Request 2**: Enable thinking → Claude continues → May or may not use thinking
4. ✅ **Works correctly**

### Flow for Complex Tasks (Thinking Generated)

1. **Request 1**: Enable thinking → Claude needs reasoning → Generates thinking blocks with signatures
2. **Cache**: Store thinking blocks keyed by tool_use IDs
3. **Request 2**: Cursor sends tool results → We reattach cached thinking blocks → Enable thinking
4. **Claude**: Continues reasoning from where it left off
5. ✅ **Works correctly**

### Flow When Cursor Strips Thinking Blocks

1. **Response**: We send thinking blocks to Cursor
2. **Cursor**: Strips them out (only keeps text + tool_calls)
3. **Next Request**: Cursor sends back message without thinking blocks
4. **Our Proxy**: Looks up tool_use IDs in cache → Reattaches thinking blocks with signatures
5. **To Anthropic**: Message now has proper thinking blocks with signatures
6. ✅ **Works correctly** (transparent to Cursor)

## Testing Results

### What Should Work Now

✅ **Simple tool calls** (list files, read code)
- Thinking enabled
- No thinking blocks generated
- No errors

✅ **Complex reasoning** (architecture analysis)
- Thinking enabled
- Thinking blocks generated
- Cached and reused

✅ **Multi-turn conversations**
- Thinking stays enabled throughout
- Blocks preserved when they exist
- No errors when they don't exist

## Key Takeaways

1. **Thinking budget is a permission, not a requirement**
   - Claude decides whether to use it
   - May use 0 tokens, some tokens, or full budget

2. **Never create thinking blocks ourselves**
   - They require signatures from Claude
   - We can only preserve and reattach existing ones

3. **"No thinking blocks" is not an error**
   - It's normal for simple tasks
   - Don't disable thinking when this happens

4. **The cache is for preservation, not creation**
   - Cache thinking blocks when Claude generates them
   - Reattach them when continuing with tools
   - Don't worry if cache is empty

5. **Always include the beta header when thinking is enabled**
   - `anthropic-beta: interleaved-thinking-2025-05-14`
   - Required for API to accept thinking parameter

## References

- [Anthropic Extended Thinking Docs](https://docs.anthropic.com/en/docs/build-with-claude/extended-thinking)
- [Messages API Reference](https://docs.anthropic.com/en/api/messages)
- [Extended Thinking with Tool Use](https://docs.anthropic.com/en/docs/build-with-claude/extended-thinking#extended-thinking-with-tool-use)

